import requests
import json
import os
from datetime import datetime, timedelta
from telegram import Bot
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters

# ØªØ¹Ø·ÙŠÙ„ ØªØ­Ø°ÙŠØ±Ø§Øª SSL
import urllib3
urllib3.disable_warnings()

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª
TELEGRAM_TOKEN = '7402560497:AAHsDY30_xgAVhUBo9dpmWWiaLsH3X3nR38'
ADMIN_CHAT_ID = 7401831506
DATA_FILE = 'gift_data.json'

# Ø§Ø³ØªØ®Ø¯Ù… Bot Ù…Ù† Ù…ÙƒØªØ¨Ø© python-telegram-bot
bot = Bot(token=TELEGRAM_TOKEN)

def is_djezzy_number(number):
    return number.startswith('07') and len(number) == 10 and number[1] in ['7', '8', '9']

def send_otp(msisdn):
    url = 'https://apim.djezzy.dz/oauth2/registration'
    payload = f'msisdn={msisdn}&client_id=6E6CwTkp8H1CyQxraPmcEJPQ7xka&scope=smsotp'
    headers = {
        'User-Agent': 'Djezzy/2.6.7',
        'Content-Type': 'application/x-www-form-urlencoded',
    }
    res = requests.post(url, data=payload, headers=headers, verify=False)
    return res.status_code == 200

def verify_otp(msisdn, otp):
    url = 'https://apim.djezzy.dz/oauth2/token'
    payload = f'otp={otp}&mobileNumber={msisdn}&scope=openid&client_id=6E6CwTkp8H1CyQxraPmcEJPQ7xka&client_secret=MVpXHW_ImuMsxKIwrJpoVVMHjRsa&grant_type=mobile'
    headers = {
        'User-Agent': 'Djezzy/2.6.7',
        'Content-Type': 'application/x-www-form-urlencoded',
    }
    res = requests.post(url, data=payload, headers=headers, verify=False)
    if res.status_code == 200:
        return res.json()
    return None

def apply_gift(msisdn, token):
    url = f'https://apim.djezzy.dz/djezzy-api/api/v1/subscribers/{msisdn}/subscription-product?include='
    headers = {
        'User-Agent': 'Djezzy/2.6.7',
        'Authorization': f'Bearer {token}',
        'Content-Type': 'application/json',
    }

    gifts = [
        {
            "id": "TransferInternet2Go",
            "type": "products",
            "meta": {
                "services": {
                    "steps": 10000,
                    "code": "FAMILY4000",
                    "id": "WALKWIN"
                }
            }
        },
        {
            "id": "TransferInternet2Go",
            "type": "products",
            "meta": {
                "services": {
                    "steps": 5000,
                    "code": "WELCOME1GB",
                    "id": "WALKWIN"
                }
            }
        },
        {
            "id": "TransferInternet2Go",
            "type": "products",
            "meta": {
                "services": {
                    "steps": 2000,
                    "code": "BONUS500MB",
                    "id": "WALKWIN"
                }
            }
        }
    ]

    results = []
    for gift in gifts:
        payload = {"data": gift}
        res = requests.post(url, json=payload, headers=headers, verify=False)
        results.append(res.json())

    return results

def load_log():
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, 'r') as f:
            return json.load(f)
    return {}

def save_log(log):
    with open(DATA_FILE, 'w') as f:
        json.dump(log, f)

def start(update, context):
    update.message.reply_text("Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø¬ÙŠØ²ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‡Ø¯ÙŠØ© 3.5 Ø¬ÙŠØºØ§ Ø¥Ù†ØªØ±Ù†Øª.")

def gift_info(update, context):
    update.message.reply_text("ğŸ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‡Ø¯ÙŠØ©:\n- 2 Ø¬ÙŠØºØ§ (Ø£Ø³Ø§Ø³ÙŠØ©)\n- 1 Ø¬ÙŠØºØ§ Ø¥Ø¶Ø§ÙÙŠØ©\n- 500 Ù…ÙŠØºØ§ Ø¥Ø¶Ø§ÙÙŠØ©\n- ØµØ§Ù„Ø­Ø© Ù„Ù…Ø¯Ø© 30 Ø¯Ù‚ÙŠÙ‚Ø©\n- Ù…ØªØ§Ø­Ø© Ù…Ø±Ø© ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©.")

def handle_text(update, context):
    text = update.message.text.strip()
    chat_id = update.message.chat_id
    log = load_log()
    now = datetime.now()

    if is_djezzy_number(text):
        msisdn = '213' + text[1:]

        if msisdn in log:
            last_time = datetime.fromisoformat(log[msisdn].get("gift_applied", "1970-01-01T00:00:00"))
            if now - last_time < timedelta(minutes=30):  # Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ Ù„Ø¬Ø¹Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ© Ù…ØªØ§Ø­Ø© ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©
                update.message.reply_text("âš ï¸ Ù„Ù‚Ø¯ Ø§Ø³ØªÙØ¯Øª Ù…Ù† Ø§Ù„Ù‡Ø¯ÙŠØ© Ù…Ø³Ø¨Ù‚Ù‹Ø§. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ 30 Ø¯Ù‚ÙŠÙ‚Ø©.")
                return

            otp_time = datetime.fromisoformat(log[msisdn].get("otp_time", "1970-01-01T00:00:00"))
            if now - otp_time < timedelta(minutes=5):
                update.message.reply_text("âœ… OTP ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¢Ù†.")
            else:
                update.message.reply_text("â³ Ø¥Ø±Ø³Ø§Ù„ OTP Ø¬Ø¯ÙŠØ¯...")
                if send_otp(msisdn):
                    update.message.reply_text("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ OTP. Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¢Ù†.")
                    log[msisdn]["otp_time"] = now.isoformat()
                    save_log(log)
                else:
                    update.message.reply_text("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ OTP.")
        else:
            update.message.reply_text("â³ Ø¥Ø±Ø³Ø§Ù„ OTP...")
            if send_otp(msisdn):
                update.message.reply_text("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ OTP. Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¢Ù†.")
                log[msisdn] = {
                    "otp_time": now.isoformat(),
                    "usage_count": 0
                }
                save_log(log)
            else:
                update.message.reply_text("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ OTP.")
        context.user_data['msisdn'] = msisdn

    elif 'msisdn' in context.user_data:
        msisdn = context.user_data['msisdn']
        otp = text
        tokens = verify_otp(msisdn, otp)

        if tokens:
            access_token = tokens['access_token']
            results = apply_gift(msisdn, access_token)
            success = any("successfully done" in r.get('message', '') for r in results)

            if success:
                update.message.reply_text("ğŸ‰ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‡Ø¯ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!\nâœ… 3.5 Ø¬ÙŠØºØ§ Ø¥Ù†ØªØ±Ù†Øª ØµØ§Ù„Ø­Ø© Ù„Ù…Ø¯Ø© 30 Ø¯Ù‚ÙŠÙ‚Ø©.")
                log[msisdn]["gift_applied"] = now.isoformat()
                log[msisdn]["usage_count"] = log[msisdn].get("usage_count", 0) + 1
                save_log(log)
            else:
                update.message.reply_text("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.")
        else:
            otp_time = datetime.fromisoformat(log.get(msisdn, {}).get("otp_time", "1970-01-01T00:00:00"))
            if now - otp_time < timedelta(minutes=5):
                update.message.reply_text("âŒ ÙƒÙˆØ¯ OTP ØºÙŠØ± ØµØ­ÙŠØ­. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")
            else:
                update.message.reply_text("âŒ ÙƒÙˆØ¯ OTP ØºÙŠØ± ØµØ­ÙŠØ­. Ø£Ø±Ø³Ù„ Ø±Ù‚Ù…Ùƒ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯.")
    else:
        update.message.reply_text("âŒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¬ÙŠØ²ÙŠ Ø£ÙˆÙ„Ø§Ù‹ (Ù…Ø«Ø§Ù„: 077xxxxxxxx).")

def main():
    bot.send_message(chat_id=ADMIN_CHAT_ID, text="âœ… Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ Pydroid3.")

    updater = Updater(token=TELEGRAM_TOKEN, use_context=True)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CommandHandler("gift", gift_info))
    dp.add_handler(MessageHandler(Filters.text & ~Filters.command, handle_text))

    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    main()
